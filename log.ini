- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    
    // 保存所选设备的引用
    DeviceInfo *device = _deviceList[indexPath.row];
    SCANLOG(@"Device selected: %@, UUID: %@", device.deviceName, device.uuid);
    
    // 停止扫描
    BOOL wasScanning = _isScanning;
    [self stopScan];
    
    // 确保停止扫描完成后再调用代理
    dispatch_async(dispatch_get_main_queue(), ^{
        // 检查代理并添加详细日志
        if (self.delegate) {
            SCANLOG(@"Delegate exists");
            if ([self.delegate respondsToSelector:@selector(scanViewController:didSelectDevice:)]) {
                SCANLOG(@"Delegate responds to didSelectDevice selector");
                [self.delegate scanViewController:self didSelectDevice:device];
                SCANLOG(@"Delegate method called");
            } else {
                SCANLOG(@"Delegate does NOT respond to didSelectDevice selector");
            }
        } else {
            SCANLOG(@"Delegate is nil");
        }
        
        // 在代理方法执行后再关闭视图
        [self dismissViewControllerAnimated:YES completion:^{
            SCANLOG(@"View dismissed");
        }];
    });
}